# To enable ssh & remote debugging on app service change the base image to the one below
#FROM mcr.microsoft.com/azure-functions/python:3.0-python3.9-appservice
FROM mcr.microsoft.com/azure-functions/python:3.0-python3.9

ARG buildprefix=/usr
ARG buildlibdir=$buildprefix/lib64

RUN apt-get install -y gcc make

WORKDIR /build

#	Install the package libgpg-error:
ADD https://gnupg.org/ftp/gcrypt/libgpg-error/libgpg-error-1.46.tar.bz2 .

RUN tar -xf libgpg-error-1.46.tar.bz2 \
  && cd libgpg-error-1.46  \
  && ./configure --prefix=$buildprefix --libdir=$buildlibdir --enable-install-gpg-error-config \
  && make \
  && make install

#	Install the package libgcrypt:
ADD https://gnupg.org/ftp/gcrypt/libgcrypt/libgcrypt-1.10.1.tar.bz2 .

RUN tar -xf libgcrypt-1.10.1.tar.bz2 \
  && cd libgcrypt-1.10.1/  \
  && ./configure --prefix=$buildprefix --libdir=$buildlibdir  \
  && make  \
  && make install

#	Install the package libassuan:
ADD https://gnupg.org/ftp/gcrypt/libassuan/libassuan-2.5.5.tar.bz2 .

RUN tar -xf libassuan-2.5.5.tar.bz2 \
  && cd libassuan-2.5.5/  \
  && ./configure  --prefix=$buildprefix --libdir=$buildlibdir  \
  && make  \
  && make install

#	Install the package libksba:
ADD https://gnupg.org/ftp/gcrypt/libksba/libksba-1.6.2.tar.bz2 .

RUN tar -xf libksba-1.6.2.tar.bz2 \
  && cd libksba-1.6.2/  \
  && ./configure  --prefix=$buildprefix --libdir=$buildlibdir  \
  && make  \
  && make install

#	Install the package New Portable Threads Library (nPth):
ADD https://gnupg.org/ftp/gcrypt/npth/npth-1.6.tar.bz2 .

RUN tar -xf npth-1.6.tar.bz2 \
  && cd npth-1.6/  \
  && ./configure  --prefix=$buildprefix --libdir=$buildlibdir  \
  && make  \
  && make install

#	Create a dynamic library for the latest version of GnuPG:
RUN echo "$buildlibdir" > /etc/ld.so.conf.d/gpg2.conf \
  && ldconfig -v

#	Install the latest version of GnuPG:
ADD https://gnupg.org/ftp/gcrypt/gnupg/gnupg-2.2.40.tar.bz2 .

RUN tar -xf gnupg-2.2.40.tar.bz2 \
  && cd gnupg-2.2.40/  \
  && ./configure --prefix=$buildprefix --libdir=$buildlibdir  \
  && sed -e '/ks_ldap_free_state/i #if USE_LDAP' \
     -e '/ks_get_state =/a #endif'           \
     -i dirmngr/server.c \
  && make \
  && make check \
  && make install

ENV AzureWebJobsScriptRoot=/home/site/wwwroot \
    AzureFunctionsJobHost__Logging__Console__IsEnabled=true

COPY ./Azure/requirements.txt /
RUN pip install -r /requirements.txt

COPY ./Azure /home/site/wwwroot
COPY ./res /home/site/wwwroot/src/main/res